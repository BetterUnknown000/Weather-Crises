<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Weather Clusters</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background:#f8f9fa; }
    #map { height:400px; border-radius:10px; }
    .legend-dot { display:inline-block; width:14px; height:14px; margin-right:6px; border:1px solid #fff; border-radius:3px; }
    .alert-banner {
      background: linear-gradient(90deg, #ffb703, #fb8500);
      color: #fff;
      border-radius: 10px;
      padding: 12px 18px;
      margin-bottom: 20px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    }
    .alert-banner strong {
      font-size: 1.1em;
      letter-spacing: 0.5px;
    }
    .alert-chip {
      display: inline-block;
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.3);
      color: #fff;
      border-radius: 999px;
      padding: 6px 12px;
      margin: 5px 6px 0 0;
      font-size: 0.9em;
      transition: background 0.2s ease;
    }
    .alert-chip:hover {
      background: rgba(255,255,255,0.3);
    }
    .alerts-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 24px;
    }
    .alerts-table th {
      background-color: #023047;
      color: #fff;
      text-align: left;
      padding: 10px;
    }
    .alerts-table td {
      padding: 8px 10px;
      border-bottom: 1px solid #eee;
    }
    .alerts-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    .alerts-table tr:hover {
      background-color: #fffae6;
    }
  </style>
</head>
<body class="container py-3">
  <h3 class="mb-3">Weather Clusters</h3>

  {% if banner_alerts and banner_alerts|length > 0 %}
  <div class="alert-banner">
    <strong>Active Weather Alerts</strong>
    <div style="margin-top:6px; font-size:0.9em; opacity:0.85;">
      Sorted by severity, then state, then city
    </div>
    <div>
      {% for a in banner_alerts %}
        <span class="alert-chip"
            data-lat="{{ a.lat }}" data-lon="{{ a.lon }}" data-city="{{ a.city }}">
        {{ a.event }} - {{ a.city }} (score {{ a.score }})
        </span>
      {% endfor %}
    </div>
  </div>
  {% else %}
  <div class="alert-banner" style="background:#4caf50;">
    <strong>No active alerts</strong>
  </div>
  {% endif %}

  <!-- simple filter -->
  <div class="d-flex align-items-center mb-2">
    <label class="me-2">Filter:</label>
    <select id="stateFilter" class="form-select form-select-sm" style="width:auto">
      <option value="ALL">All</option>
      <option value="PA">PA</option>
      <option value="NJ">NJ</option>
      <option value="NY">NY</option>
    </select>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-lg-7">
      <div id="map"></div>
      <div class="mt-2" id="legend"></div>
      <small class="text-muted d-block">Color = cluster id. Hover a dot for the city.</small>
    </div>
    <div class="col-lg-5">
      <canvas id="bar" height="200"></canvas>
    </div>
  </div>

  <h6>Cluster Summary (Averages)</h6>
  <table class="table table-sm table-striped" id="summary-table">
    <thead class="table-light" id="summary-head">
      <tr>
        <th>Cluster</th>
        {% for col in display_cols %}
          <th>{{ col }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody id="summary-body">
      {% for s in summary %}
      <tr>
        <td>{{ s.cluster }}</td>
        {% for col in display_cols %}
          <td>{{ s[col] }}</td>
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <h6>City Weather Data</h6>
  <div class="table-responsive">
    <table class="table table-sm table-striped" id="city-table">
      <thead class="table-light" id="city-head">
        <tr>
          <th>City</th>
          <th>Cluster</th>
          {% for col in display_cols %}
            <th>{{ col }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody id="city-body">
        {% for r in rows %}
        <tr>
          <td>{{ r.city }}</td>
          <td>{{ r.cluster }}</td>
          {% for col in display_cols %}
            <td>{{ r[col] }}</td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <script>
    // server data
    const rowsAll     = {{ rows|tojson }};
    const displayCols = {{ display_cols|tojson }};
    const colors = ["#2E86AB", "#F18F01", "#C73E1D", "#8A3FFC", "#E83E8C", "#7A7A7A"];
    const fmt = v => (v==null||v===""||isNaN(v)? "-" : Number(v).toFixed(2));

    let map = null, chart = null;

    function byState(rows, state) {
      if (state === "ALL") return rows;
      return rows.filter(r => (r.city || "").trim().endsWith(", " + state));
    }

    function computeCounts(rows) {
      const m = new Map();
      rows.forEach(r => m.set(r.cluster, (m.get(r.cluster)||0)+1));
      return Array.from(m.entries()).sort((a,b)=>a[0]-b[0])
                  .map(([cluster,count]) => ({cluster, count}));
    }

    function computeSummary(rows) {
      const g = new Map();
      rows.forEach(r => {
        if (!g.has(r.cluster)) g.set(r.cluster, []);
        g.get(r.cluster).push(r);
      });
      return Array.from(g.entries()).sort((a,b)=>a[0]-b[0]).map(([cluster, arr]) => {
        const out = { cluster };
        displayCols.forEach(col => {
          const vals = arr.map(x => Number(x[col])).filter(v => !isNaN(v));
          const mean = vals.length ? (vals.reduce((a,b)=>a+b,0)/vals.length) : null;
          out[col] = (mean==null ? "-" : Number(mean).toFixed(2));
        });
        return out;
      });
    }

    function destroyChart(){ if (chart){ chart.destroy(); chart = null; } }
    function clearMap(){ if (map){ map.remove(); map = null; } }

    function render(state = "ALL") {
      const rows = byState(rowsAll, state);
      const counts = computeCounts(rows);
      const summary = computeSummary(rows);

      // map
      clearMap();
      map = L.map("map").setView([40.8, -77.7], 7);
      L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 12, minZoom: 4, attribution: "OpenStreetMap"
      }).addTo(map);

      const markers = [];
      rows.forEach(r => {
        if (typeof r.lat !== "number" || typeof r.lon !== "number") return;
        const c = (typeof r.cluster === "number" && r.cluster >= 0)
          ? colors[r.cluster % colors.length] : "#999999";
        const tip =
          (r.city ?? "City") + "\n" +
          "|| Avg Temp: " + fmt(r["Average Temperature (F)"]) + " F";
        const mk = L.circleMarker([r.lat, r.lon], {
          radius: 7, color:"#fff", weight:1, fillColor:c, fillOpacity:0.9
        }).bindTooltip(tip);
        mk.addTo(map);
        markers.push(mk);
      });
      if (markers.length) map.fitBounds(L.featureGroup(markers).getBounds().pad(0.3));

      // legend
      const legend = document.getElementById("legend");
      legend.innerHTML = "";
      [...new Set(rows.map(r => r.cluster).filter(x => typeof x === "number"))]
        .sort((a,b)=>a-b).forEach(i => {
          const dot = document.createElement("span");
          dot.className = "legend-dot";
          dot.style.background = colors[i % colors.length];
          const t = document.createElement("span");
          t.textContent = "cluster " + i;
          const box = document.createElement("div");
          box.style.display = "inline-block";
          box.style.marginRight = "12px";
          box.appendChild(dot); box.appendChild(t);
          legend.appendChild(box);
        });

      // bar chart
      destroyChart();
      const ctx = document.getElementById("bar").getContext("2d");
      chart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: counts.map(x => "cluster " + x.cluster),
          datasets: [{
            label: "cities",
            data: counts.map(x => x.count),
            backgroundColor: counts.map((_,i)=>colors[i%colors.length])
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display:false }, title: { display:true, text:"cluster sizes" } },
          scales: { y: { beginAtZero:true, ticks:{ precision:0 } } }
        }
      });

      // tables: summary
      const sbody = document.getElementById("summary-body");
      sbody.innerHTML = "";
      summary.forEach(row => {
        const tr = document.createElement("tr");
        let html = `<td>${row.cluster}</td>`;
        displayCols.forEach(col => { html += `<td>${row[col]}</td>`; });
        tr.innerHTML = html;
        sbody.appendChild(tr);
      });

      // tables: city
      const cbody = document.getElementById("city-body");
      cbody.innerHTML = "";
      rows.forEach(r => {
        const tr = document.createElement("tr");
        let html = `<td>${r.city}</td><td>${r.cluster}</td>`;
        displayCols.forEach(col => { html += `<td>${fmt(r[col])}</td>`; });
        tr.innerHTML = html;
        cbody.appendChild(tr);
      });
    }

    render("ALL");
    let highlight = null;

  function focusPoint(lat, lon, city) {
    if (!map) return;
    map.setView([lat, lon], 9); // zoom in a bit

    // remove old highlight
    if (highlight) {
      try { map.removeLayer(highlight); } catch (_) {}
      highlight = null;
    }

    // draw a temporary ring highlight
    highlight = L.circleMarker([lat, lon], {
      radius: 11, color: "#000", weight: 2, fillColor: "#ffff00", fillOpacity: 0.6
    }).addTo(map).bindTooltip(city).openTooltip();

    // fade it out after a few seconds
    setTimeout(() => {
      if (highlight) {
        try { map.removeLayer(highlight); } catch (_) {}
        highlight = null;
      }
    }, 4000);
  }

  // delegate click events on chips
  document.addEventListener("click", (e) => {
    const el = e.target;
    if (el.classList && el.classList.contains("alert-chip")) {
      const lat = parseFloat(el.dataset.lat);
      const lon = parseFloat(el.dataset.lon);
      const city = el.dataset.city || "Location";
      if (!isNaN(lat) && !isNaN(lon)) {
        focusPoint(lat, lon, city);
      }
    }
  });
    document.getElementById("stateFilter").addEventListener("change", e => render(e.target.value));
  </script>
</body>
</html>
